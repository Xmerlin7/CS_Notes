# Explanation
- #### Exceptions
	- Exceptions are events that cause changes to program flow. 
	- When an exception happens, the processor suspends the current executing task and executes a part of the program called the exception handler.
	- The exception handlers for interrupts are also referred to as Interrupt Service Routines (ISR).
	- Exceptions are processed by the NVIC. 
	- The NVIC can handle a number of Interrupt Requests (IRQs) and a Non-Maskable Interrupt (NMI) request. 
	- The processor itself is also a source of exception events. These could be fault events that indicate system error conditions, or exceptions generated by software to support embedded OS operations.
	 ![[Various exception sources.png|500]]
	- Each exception source has an exception number. 
	- Exception numbers 1 to 15 are classified as system exceptions, and exceptions 16 and above are for interrupts. 
	- The design of the NVIC in the Cortex-M3 and Cortex-M4 processors can support up to 240 interrupt inputs. However, in practice the number of interrupt inputs implemented in the design is far less, typically in the range of 16 to 100.
	 ![[Exception Types.png|700]]
	- The exception number is reflected in various registers, including the IPSR, and it is used to determine the exception vector addresses.
	- Exception vectors are stored in a vector table, and the processor reads this table to determine the starting address of an exception handler during the exception entrance sequence.
	- The [[Cortex-M3 & Cortex-M4 Processors]] execute the reset handler in Thread mode (rather than Handler mode as in other exceptions). Also the exception number in IPSR is read as zero.
- #### Nested vectored interrupt controller (NVIC)
	- The NVIC is a part of the Cortex-M processor. 
	- It is programmable and its registers are located in the System Control Space (SCS) of the[[Memory system#^4ea034| memory map]].
	- The NVIC handles the exceptions and interrupt configurations, prioritization, and interrupt masking.
	- The NVIC has the following features:
		1. Flexible exception and interrupt management:
			- Each interrupt (apart from the NMI) can be enabled or disabled and can have its pending status set or cleared by software.
		2. Nested exception/interrupt support
			- Each exception has a priority level. Some exceptions, such as interrupts, have programmable priority levels and some others (e.g., NMI) have a fixed priority level. 
			- When an exception occurs, the NVIC will compare the priority level of this exception to the current level.
		3. Vectored exception/interrupt entry
			- When an exception occurs, the processor will need to locate the starting point of the corresponding exception handler.
			- The Cortex-M processors automatically locate the starting point of the exception handler from a vector table in the memory.
		4. Interrupt masking
			- The NVIC in the Cortex-M3 and Cortex-M4 processors provide several interrupt masking registers such as the PRIMASK special register.
			- Also, you can also use the BASEPRI register to select mask exceptions or interrupts which are below a certain priority level.
- #### Vector table ^c2826c
	- To determine the starting address of the exception handler, a vector table mechanism is used. 
	- The vector table is an array of word data inside the system memory, each representing the starting address of one exception type.
	- The vector table is relocatable and the relocation is controlled by a programmable register in the NVIC called the **Vector Table Offset Register (VTOR)**. 
	- After reset, the VTOR is reset to 0; therefore, the vector table is located at address 0x0 after reset.
	- For example, if the reset is exception type 1, the address of the reset vector is 1 times 4 (each word is 4 bytes), which equals 0x00000004, and the NMI vector (type 2) is located at $2 * 4 = 0x00000008$. 
	- The address 0x00000000 is used to store the starting value of the MSP.
	- The LSB of each exception vector indicates whether the exception is to be executed in the Thumb state. 
	- Since the Cortex-M processors can support only Thumb instructions, the LSB of all the exception vectors should be set to 1.
	 ![[Exception types table.png|500]]
- #### Fault handling
	- Fault exceptions are triggered when the processor detects an error.
	- By default the Bus Fault, Usage Fault, and Memory Management Fault are disabled and all fault events trigger the HardFault exception. 
	- The configurations are programmable and you can enable the three programmable fault exceptions individually to handle different types of faults. 
	- The HardFault exception is always enabled.
	 ![[Fault exceptions usages.png]]
- #### System control block (SCB)
	- One part of the processor that is merged into the NVIC unit is the SCB. The SCB contains various registers for:
		- Controlling processor configurations (e.g., low power modes).
		- Providing fault status information (fault status registers).
		- Vector table relocation (VTOR).
- #### Reset and reset sequence
	- In typical Cortex-M microcontrollers, there can be three types of reset:
		- Power on reset e reset everything in the microcontroller. This includes the processor and its debug support component and peripherals.
		- System reset e reset just the processor and peripherals, but not the debug support component of the processor.
		- Processor reset e reset the processor only.
	- The debug host can generate a system reset or processor reset via a register in the System Control Block (SCB).
	- In some cases the reset lasts a number of milli seconds as the reset controller needs to wait for a clock source such as a crystal oscillator to stabilize.
	- After reset and before the processor starts executing the program, the Cortex-M processors read the first two words from the memory.
	- After these two words are read by the processor, the processor then sets up the MSP and the Program Counter (PC) with these values.
	 ![[Reset sequence.png]]
# Sources
- The Definitive Guide to ARM Cortex-M3 and Cortex-M4 Processors 4.5